# AI æ¨¡å—ç”Ÿäº§å°±ç»ªæ€§è¯„ä¼°

## æ¦‚è¿°

æœ¬æ–‡æ¡£æ˜¯å¯¹ Bingo é¡¹ç›® AI ç›¸å…³ä»£ç çš„ç”Ÿäº§å°±ç»ªæ€§è¯„ä¼°ã€‚è¯„ä¼°åŸºäºä»£ç å®¡æŸ¥å’Œè¡Œä¸šæœ€ä½³å®è·µï¼Œæ—¨åœ¨è¯†åˆ«é£é™©å¹¶æä¾›æ”¹è¿›å»ºè®®ã€‚

**è¯„ä¼°æ—¥æœŸ**ï¼š2026-01-07
**è¯„ä¼°èŒƒå›´**ï¼š`pkg/ai/`ã€`internal/pkg/ai/`ã€`internal/apiserver/biz/chat/`

---

## æ•´ä½“è¯„åˆ†

| ç»´åº¦ | è¯„ä¼°æ—¶ | å½“å‰ | çŠ¶æ€ |
|------|--------|------|------|
| åŠŸèƒ½å®Œæ•´æ€§ | 8/10 | 9/10 | âœ… è‰¯å¥½ |
| ç¨³å®šæ€§ä¸å®¹é”™ | 7/10 | 9/10 | âœ… è‰¯å¥½ |
| æ€§èƒ½ä¸å¯æ‰©å±•æ€§ | 6/10 | 8/10 | âœ… è‰¯å¥½ |
| å®‰å…¨æ€§ | 7/10 | 8/10 | âœ… è‰¯å¥½ |
| å¯è§‚æµ‹æ€§ | 6/10 | 9/10 | âœ… è‰¯å¥½ |
| æµ‹è¯•è¦†ç›– | 4/10 | 4/10 | âš ï¸ å¾…æ”¹è¿› |

**æ€»ä½“ç»“è®º**ï¼šP0 å’Œ P1 æ”¹è¿›å·²å®æ–½ï¼Œæ ¸å¿ƒç¨³å®šæ€§æœºåˆ¶å°±ç»ªã€‚å»ºè®®å°æµé‡è¯•è¿è¡Œï¼Œæ ¹æ®å®é™…æ•°æ®å†³å®š P2 ä¼˜å…ˆçº§ã€‚

---

## å®æ–½è®°å½•

### P0 ä¿®å¤ (å·²å®Œæˆ - commit a8f0e29)

| ä»»åŠ¡ | å®ç°æ–¹å¼ | æ–‡ä»¶ |
|------|----------|------|
| è¾“å…¥é•¿åº¦é™åˆ¶ | `maxMessageChars = 15000`ï¼Œ`validateMessageLength()` | `chat.go`, `errno/ai.go` |
| RPM é™æµ | Redis INCR + åˆ†é’Ÿçº§ keyï¼Œ`CheckRPM()` | `quota.go` |
| Quota é‡Šæ”¾å¯é  | å¼‚æ­¥ goroutine â†’ åŒæ­¥ 5s è¶…æ—¶ | `chat.go` |

### P1 ä¿®å¤ (å·²å®Œæˆ - commit 20c408d)

| ä»»åŠ¡ | å®ç°æ–¹å¼ | æ–‡ä»¶ |
|------|----------|------|
| ç†”æ–­å™¨ | Closed/Open/Half-Open ä¸‰æ€ï¼Œ5 æ¬¡å¤±è´¥è§¦å‘ | `circuit_breaker.go` |
| AI Metrics | Prometheus æŒ‡æ ‡ (8 ä¸ª metric) | `metrics.go` |
| å¥åº·æ£€æŸ¥ | 5 åˆ†é’Ÿé—´éš” pingï¼Œ`HealthStatus()` API | `health_checker.go` |

---

## æ¶æ„æ¦‚è§ˆ

### åˆ†å±‚ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Handler Layer (internal/apiserver/handler/http/chat/)      â”‚
â”‚  - HTTP è¯·æ±‚å¤„ç†                                             â”‚
â”‚  - SSE æµå¼å“åº”                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Biz Layer (internal/apiserver/biz/chat/)                   â”‚
â”‚  - Chat ä¸šåŠ¡ç¼–æ’                                             â”‚
â”‚  - Session ç®¡ç†                                              â”‚
â”‚  - Quota é…é¢æ§åˆ¶                                            â”‚
â”‚  - Fallback é™çº§                                             â”‚
â”‚  - Circuit Breaker (NEW)                                    â”‚
â”‚  - Health Checker (NEW)                                     â”‚
â”‚  - Metrics (NEW)                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Provider Layer (pkg/ai/providers/)                         â”‚
â”‚  - OpenAI / Claude / Gemini / Qwen                          â”‚
â”‚  - ç»Ÿä¸€ Provider æ¥å£                                        â”‚
â”‚  - é‡è¯•æœºåˆ¶                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Store Layer (internal/pkg/store/)                          â”‚
â”‚  - Model / Session / Message / Quota                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| Registry | `pkg/ai/registry.go` | Provider æ³¨å†Œä¸å‘ç° |
| Retry | `pkg/ai/retry.go` | æŒ‡æ•°é€€é¿é‡è¯• |
| Loader | `internal/pkg/ai/loader.go` | DB é…ç½®åŠ è½½åˆ° Registry |
| Fallback | `internal/pkg/ai/fallback.go` | æ¨¡å‹é™çº§é€‰æ‹© |
| Quota | `internal/apiserver/biz/chat/quota.go` | Redis åŸå­é…é¢ç®¡ç† |
| Chat | `internal/apiserver/biz/chat/chat.go` | Chat æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ |
| CircuitBreaker | `chat/circuit_breaker.go` | ç†”æ–­å™¨ |
| Metrics | `chat/metrics.go` | Prometheus æŒ‡æ ‡ |
| HealthChecker | `chat/health_checker.go` | å¥åº·æ£€æŸ¥ |

---

## è¯¦ç»†è¯„ä¼°

### 1. åŠŸèƒ½å®Œæ•´æ€§ (9/10)

**ä¼˜ç‚¹**ï¼š
- âœ… æ”¯æŒå¤š Providerï¼ˆOpenAIã€Claudeã€Geminiã€Qwen ç­‰ï¼‰
- âœ… æµå¼å’Œéæµå¼ Chat
- âœ… Session å†å²ç®¡ç† + æ»‘åŠ¨çª—å£
- âœ… Agent Presetï¼ˆSystem Prompt æ³¨å…¥ï¼‰
- âœ… TPD é…é¢ç®¡ç†
- âœ… é…ç½®çƒ­åŠ è½½ï¼ˆRedis Pub/Sub + è½®è¯¢é™çº§ï¼‰
- âœ… OpenAI å…¼å®¹ API
- âœ… **RPM é™æµ** (NEW)

**ä¸è¶³**ï¼š
- âš ï¸ æ— æ¨¡å‹ç¦ç”¨åçš„åŠ¨æ€æ‘˜é™¤

---

### 2. ç¨³å®šæ€§ä¸å®¹é”™ (9/10)

**ä¼˜ç‚¹**ï¼š
- âœ… æŒ‡æ•°é€€é¿é‡è¯•ï¼ˆ500ms â†’ 10s maxï¼‰
- âœ… æ™ºèƒ½åˆ¤æ–­å¯é‡è¯•é”™è¯¯ï¼ˆ429ã€502ã€503ã€504ã€timeoutï¼‰
- âœ… Fallback é™çº§æœºåˆ¶
- âœ… Quota é¢„ç•™ + è°ƒæ•´æ¨¡å¼ï¼ˆRedis åŸå­æ“ä½œï¼‰
- âœ… å¤±è´¥å›æ»šé…é¢
- âœ… **ç†”æ–­å™¨** (NEW) - é˜²æ­¢é›ªå´©
- âœ… **Quota åŒæ­¥é‡Šæ”¾** (NEW) - ç¡®ä¿å¯é æ€§

**å‰©ä½™é—®é¢˜**ï¼š

| é—®é¢˜ | ä½ç½® | é£é™© |
|------|------|------|
| Fallback ä»…ä¸€æ¬¡ | `chat.go` | ğŸŸ¡ å¤š Provider æ—¶å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯• |
| Redis å•ç‚¹ | `quota.go` | ğŸŸ¢ å¯é€šè¿‡ Redis Cluster è§£å†³ |

---

### 3. æ€§èƒ½ä¸å¯æ‰©å±•æ€§ (8/10)

**ä¼˜ç‚¹**ï¼š
- âœ… æµå¼å“åº”å¸¦ç¼“å†² channelï¼ˆbuffer=100ï¼‰
- âœ… å¼‚æ­¥åå°å¤„ç†ï¼ˆSession ä¿å­˜ã€Quota è°ƒæ•´ï¼‰
- âœ… ä¼šè¯å†å²æ»‘åŠ¨çª—å£
- âœ… **RPM é™æµ** (NEW) - é˜²æ­¢æ»¥ç”¨
- âœ… **è¾“å…¥é•¿åº¦é™åˆ¶** (NEW) - é˜²æ­¢ OOM

**å‰©ä½™é—®é¢˜**ï¼š

| é—®é¢˜ | ä½ç½® | é£é™© |
|------|------|------|
| N+1 æŸ¥è¯¢ | `chat.go` | ğŸŸ¢ æ¯æ¬¡è¯·æ±‚æŸ¥è¯¢ DB å†å²ï¼Œå¯ç¼“å­˜ |
| Redis Pipeline | `quota.go` | ğŸŸ¢ å¤šæ¬¡å¾€è¿”å¯ä¼˜åŒ– |

---

### 4. å®‰å…¨æ€§ (8/10)

**ä¼˜ç‚¹**ï¼š
- âœ… API Key æ”¯æŒç¯å¢ƒå˜é‡ï¼ˆViper AutomaticEnvï¼‰
- âœ… Session UID éªŒè¯
- âœ… é…ç½®æ–‡ä»¶å·²æ·»åŠ ç¯å¢ƒå˜é‡æ³¨é‡Š
- âœ… **è¾“å…¥é•¿åº¦é™åˆ¶** (NEW) - é˜²æ­¢ OOM æ”»å‡»
- âœ… **RPM é™æµ** (NEW) - é˜²æ­¢æ»¥ç”¨

**å‰©ä½™é—®é¢˜**ï¼š

| é—®é¢˜ | ä½ç½® | é£é™© |
|------|------|------|
| Prompt æ³¨å…¥é£é™© | `chat.go` | ğŸŸ¡ Agent SystemPrompt ç›´æ¥æ³¨å…¥ |
| èŠå¤©è®°å½•æ˜æ–‡ | DB | ğŸŸ¢ ç¬¦åˆè¡Œä¸šå®è·µ |

---

### 5. å¯è§‚æµ‹æ€§ (9/10)

**ä¼˜ç‚¹**ï¼š
- âœ… ç»“æ„åŒ–æ—¥å¿—ï¼ˆzapï¼‰
- âœ… TraceID æ”¯æŒï¼ˆ`log.C(ctx)` è‡ªåŠ¨æå–ï¼‰
- âœ… Metrics ç«¯ç‚¹ï¼ˆ`/metrics`ï¼‰
- âœ… PProf æ”¯æŒ
- âœ… **AI ä¸“ç”¨ Metrics** (NEW)
  - `ai_request_duration_seconds` - è¯·æ±‚è€—æ—¶
  - `ai_requests_total` - è¯·æ±‚è®¡æ•°
  - `ai_fallback_total` - é™çº§æ¬¡æ•°
  - `ai_quota_reservation_total` - é…é¢æ“ä½œ
  - `ai_circuit_breaker_state` - ç†”æ–­å™¨çŠ¶æ€
  - `ai_circuit_breaker_failures_total` - ç†”æ–­æ¬¡æ•°
  - `ai_rpm_rejections_total` - é™æµæ‹’ç»
- âœ… **Provider å¥åº·æ£€æŸ¥** (NEW)

**å‰©ä½™é—®é¢˜**ï¼š

| é—®é¢˜ | é£é™© |
|------|------|
| æ—  Distributed Tracing | ğŸŸ¢ è·¨æœåŠ¡è°ƒç”¨è¿½è¸ªï¼Œå¯é€‰ |

---

### 6. æµ‹è¯•è¦†ç›– (4/10)

**ç°æœ‰æµ‹è¯•**ï¼š
- âœ… `pkg/ai/registry_test.go` - Registry æ³¨å†Œ/æŸ¥æ‰¾
- âœ… `pkg/ai/retry_test.go` - é‡è¯•é€»è¾‘
- âš ï¸ `pkg/ai/providers/*_test.go` - ä¾èµ–çœŸå® API

**ç¼ºå¤±**ï¼š

| ç¼ºå¤± | é£é™© |
|------|------|
| Chat Biz é›†æˆæµ‹è¯• | æ ¸å¿ƒæµç¨‹æœªéªŒè¯ |
| Quota å¹¶å‘æµ‹è¯• | åŸå­æ“ä½œæœªéªŒè¯ |
| Fallback æµç¨‹æµ‹è¯• | é™çº§é€»è¾‘æœªæµ‹è¯• |
| Stream è¾¹ç•Œæµ‹è¯• | å¼‚å¸¸æƒ…å†µå¤„ç†æœªéªŒè¯ |

---

## P2 å¤„ç†å»ºè®®

### å‰©ä½™ä¼˜åŒ–é¡¹

| ä¼˜å…ˆçº§ | é—®é¢˜ | æ”¶ç›Š | å·¥ä½œé‡ | å»ºè®® |
|--------|------|------|--------|------|
| ğŸŸ¢ P2 | ä¼šè¯å†å²ç¼“å­˜ | å‡å°‘ DB æŸ¥è¯¢ | 2-3h | è¿è¡Œåæ ¹æ® DB è´Ÿè½½å†³å®š |
| ğŸŸ¢ P2 | Redis Pipeline | ä¼˜åŒ–é…é¢æ“ä½œ | 1h | è¿è¡Œåæ ¹æ® Redis å»¶è¿Ÿå†³å®š |
| ğŸŸ¢ P2 | é›†æˆæµ‹è¯• | æ ¸å¿ƒæµç¨‹éªŒè¯ | 4-6h | å¯åœ¨ç°åº¦æœŸé—´å¹¶è¡Œè¿›è¡Œ |
| ğŸŸ¢ P2 | Distributed Tracing | è·¨æœåŠ¡è¿½è¸ª | 4-6h | å¤šæœåŠ¡åœºæ™¯ä¸‹è€ƒè™‘ |

### æ¨èç­–ç•¥

**æŒ‰éœ€å®æ–½**ï¼š
1. **å…ˆä¸Šçº¿** - P0+P1 å·²å®Œæˆï¼Œæ ¸å¿ƒç¨³å®šæ€§å°±ç»ª
2. **è§‚å¯ŸæŒ‡æ ‡** - é€šè¿‡ /metrics æ”¶é›†çœŸå®è¿è¡Œæ•°æ®
3. **é’ˆå¯¹æ€§ä¼˜åŒ–** - æ ¹æ®ç“¶é¢ˆå†³å®š P2 ä¼˜å…ˆçº§

**ä¸å»ºè®®é¢„å…ˆå®æ–½**ï¼š
- ä¼šè¯ç¼“å­˜ - æœªéªŒè¯æ˜¯å¦ä¸ºç“¶é¢ˆ
- Pipeline - å¾®ä¼˜åŒ–ï¼Œå¯èƒ½æ”¶ç›Šä¸å¤§
- Distributed Tracing - å•æœåŠ¡åœºæ™¯ä¸éœ€è¦

---

## ä¸Šçº¿æ£€æŸ¥æ¸…å•

### ä¸Šçº¿å‰

- [x] P0 ä¿®å¤å®Œæˆ
- [x] P1 ä¿®å¤å®Œæˆ
- [x] Lint é€šè¿‡
- [x] ç¼–è¯‘é€šè¿‡
- [ ] é…ç½®æ–‡ä»¶å‡†å¤‡ï¼ˆAPI Keyã€é»˜è®¤æ¨¡å‹ï¼‰
- [ ] Redis è¿æ¥éªŒè¯
- [ ] æ•°æ®åº“è¿ç§»æ‰§è¡Œ

### ç°åº¦é˜¶æ®µ

- [ ] å°æµé‡è¯•è¿è¡Œï¼ˆ1-5%ï¼‰
- [ ] ç›‘æ§ Metrics æŒ‡æ ‡æ­£å¸¸
- [ ] æ— é”™è¯¯æ—¥å¿—æ¿€å¢
- [ ] å“åº”æ—¶é—´ç¬¦åˆé¢„æœŸ

### å…¨é‡ä¸Šçº¿

- [ ] é€æ­¥æ”¾é‡ï¼ˆ25% â†’ 50% â†’ 100%ï¼‰
- [ ] è®¾ç½®å‘Šè­¦é˜ˆå€¼
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

---

## å‚è€ƒæ–‡æ¡£

- [OpenAI Enterprise Privacy](https://openai.com/enterprise-privacy/)
- [How to Handle PII When Using AI](https://www.cbtnuggets.com/blog/technology/data/how-to-handle-pii-when-using-ai)
- [A Guide to Configuration Management in Go with Viper](https://dev.to/kittipat1413/a-guide-to-configuration-management-in-go-with-viper-5271)
